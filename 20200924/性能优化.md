# 性能优化

![i](https://img1.sycdn.imooc.com/5f1cea350001ac2b13800528.png)

## 引言

* 需求: 百万级数据订单表，数据查询与导出

  * 如何在保证查询与导出速度的同时，业务中的订单读写不受影响？
  * 解决了，然后呢？下次怎么办
  * 场景那么多，如何才能以不变应万变

## 一、为什么要优化? 什么时候优化

### 1.1 为什么要优化

* 实际上是良好的用户体验（背后是赚钱）和有限的资源的矛盾（投入、成本）

* 比如：
  * 页面响应时间太长
  * 操作的失败率太高
  * 竞品的软件更流畅，体验更好

### 1.2 什么时候优化

一个普遍的共识：当性能成为瓶颈的时候

优秀的程序员可以在设计之初就想到合理的方案（投入产出比的权衡）。

简单的代价小的尽早优化。

## 二、怎么优化

### 2.1 方向

1、堆硬件 + 优化软件（应用软件
2、提高资源利用率 → 合理利用资源（硬件、软件）
3、权衡（生活、技术很多事都是这样）

### 2.2 硬件

* CPU（运算器、控制器）
  * 在选购CPU产品的时候，可以看一下CPU的主频、核心数和外频等参数就可以，如果是同一代的产品在数字序号上越大，性能越强，不同代的一般是越新的产品性能越强

* 内存（存储）
  * 内存的容量大一些（也不是越大越好, 32 位系统最大支持 4G内存;  成本问题; 内存只是一方面,其他部分可能成为瓶颈）
  * 最大内存寻址空间是2的32次方= 4（GB）左右

* 磁盘（存储）
  * 常见的硬盘分类: 机械硬盘和固态硬盘
  * 取舍：读写速度、成本、噪音、轻便的取舍
  * 规律：减少次数；磁盘IO 顺序读优于随机读

* 网络（输入、输出）
  * 增大宽带（上传、下载）
  * 直观感受：宽带小下载东西慢，玩游戏卡...

### 2.3 软件

* 化零为整
* 空间换时间
* 时空局部性局部性（顺序读写优于随机读写）
* 选择最合适的存储媒介和存储结构（订单历史方案，HBASE，ES）
* 减少耗资源操作（减少存储空间；减少IO次数；如压缩、合并、批量）
* 增加（增加CPU利用率）
* 同步转异步
* 串行转并行
* 知道原理/根据技术特点去优化（深翻页）
* 化整为零
* 反推产品调整业务逻辑

## 三、展开

### 3.1 化整为零 Or 空间换时间  or 增加 or 冗余

* 增加更多的资源（人、硬件、软件）
* 也不是越多越好，实际上我们发现是存在阈值的（有些任务有相互依赖；人多成本高，工资、沟通成本）

### 3.2 负载平衡

* 概述下就是将大量作业合理地分摊到多个操作单元上进行执行，用于解决互联网架构中的高并发和高可用的问题。

### 3.3 分库分表和业务拆分

* 不同的表拆分的不同的数据库中 → 垂直拆分

![i](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9fdb1430-2e01-4fa2-b2b4-2a3d1c177fac%2FUntitled.png?table=block&id=217a3e9e-76ea-4375-b383-b4ea3fd828e6&width=1540&userId=&cache=v2)

* 一个表中的数据按照不同的条件，拆分到多台数据库主机上 → 水平拆分

![i](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5ab45d94-b69b-4be1-9f84-623fb2040a76%2FUntitled.png?table=block&id=5c7fc59e-7606-4233-b021-4edd057fcd4e&width=1140&userId=&cache=v2)

* 这样提高了性能，但是也带来了一些新的问题，如引入分布式事务、跨节点的 join 问题、跨节点的合并排序分页问题、多数据源的管理等。
* 分库分表的本质是化整为零。

### 3.4 读写分离

* 读写分离的将读和写分别分散到不同的业务逻辑中，本质也属于化整为零

* 缺点：
  * 延迟
  * 同步会造成一些开销。（实际上也是用空间换时间的一种做法）

### 3.5 集群

* 原本一台服务器，随着业务发展性能变差
* 使用多台服务器搭建集群，实现流量负载均衡分担

### 3.6 消息队列（串行转并行）

* 业务场景描述：
  * 在直播开始前 M 分钟要发送微信公众号消息提醒用户前来观看。
  * 一场直播的订阅量可能有几个，可能几百个，可能几万个，甚至十万，百万个订阅用户。
  * 如何快速将消息发送到用户手上？
  * 延时任务只会回调到一台机器上，如果直接在这台机器上发送，即使使用线程池推送能力也是有限，而且任务过多可能会影响整个服务的响应时间。

* 方案：
  * 为了尽快发送到用户手中，将查询到的消息拆分成 每 10个一组，给 MQ，然后 MQ 负载均衡到服务器集群中。
  * 只要有一台可以消费MQ的任务，那么消息推送能力增强至少 N 倍 (N 指推送人数)
  * 另外待推送的用户可以放到缓存中，这样查询待推送用户列表性能也会更好。（不过要注意数据的一致性）

### 3.7 缓存

* 随着业务增长，内容信息越来越复杂，用户数和访问量越来越大，而我们的应用服务器资源是有限的，数据库每秒能接受的请求次数也是有限的（或者文件的读写也是有限的），我们应用必须借助缓存来提供尽可能高的吞吐量。而我们常用的缓存又分为（本地缓存）和（分布式缓存）。

* 本地缓存
  * 优点：应用和cache是在同一个进程内部，请求缓存非常快速，没有网络开销
  * 缺点：容量有限，不能存放过多的内容

* 分布式缓存：
  * 与应用分离的缓存组件或服务，如redis，CDN
  * 优点：存储容量大，跟机器有关不受应用影响；缓存全局共享
  * 缺点：存在网络开销，存取速度较慢（相对于本地缓存）

### 3.8 冗余 和 预热

* 异步生成报表、离线数据统计、异步日志、预热数据

![i](https://img1.sycdn.imooc.com/5f1ce9e100010aa104880368.png)

* 实际案例： 活动预热

  * 比如直播业务，预计会有几百万用户在几分钟时间内涌入，直播前几天陆续会有一些用户订阅直播，大多数用户会在直播开始前后5分钟进入。 如何优化？

    * 1 压力测试，服务器扩容（硬件方面）
    * 2 活动前预热（软件方面） 根据直播id 和活动时间，设置直播前 N 分钟预热，将购买的结果缓存起来；如果退订也可以删除缓存，退订毕竟是少数。通过预热的方式，用户短时间涌入直播间鉴权时，大多数流量打到缓存集群中，DB 压力会很小。
    * 3  基于 Hytrix 降级（到重试页面）或者限流

浪费空间，又要尽可能少得哈希冲突。

### 3.9 算法与数据结构

* 合适的数据结构
* 合适的排序算法
* 合适的查询算法
  * 二分查找
  * 动态规划
    * 动态规划背后的基本思想非常简单。大致上，若要解一个给定问题，我们需要解其不同部分（即子问题），再根据子问题的解以得出原问题的解。
    * 通常许多子问题非常相似，为此动态规划法试图仅仅解决每个子问题一次，从而减少计算量
    * 一旦某个给定子问题的解已经算出，则将其记忆化存储，以便下次需要同一个子问题解之时直接查询
    * 这种做法在重复子问题的数目关于输入的规模呈指數增長时特别有用

## 四、三思而后行

### 4.1 不要过早优化

## 4.2 考虑投入产出比

如果某个优化提效甚微，但是投入很大，不应该进行优化，或者换个方案

## 4.3 考虑正确性、可维护性、可拓展性、安全性等

* 正确性
  * 通过单元测试、功能测试等保证正确性
  * 加缓存，如果做不好一致性，没评估到所有的入口，导致修改DB时没有更新缓存，可能出现故障
* 稳定性
  * 要考虑必要的限流和降级
* 安全性问题
  * 为了优化，去掉了必要的校验，如判断文件是否属于用户等。
* 可维护性
  * 为了减少对象转换而从前端到后端都用一个对象，导致修改的影响较大

## 五、图书推荐

* 《性能之巅》⭐
* 《图解性能优化》
* 《Web 性能权威指南》
* 《Java性能权威指南》
* 《深入理解计算机系统》

## 总结

![i](https://img1.sycdn.imooc.com/5f202fac000104c028623060.png)

## THANKS
